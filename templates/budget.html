{% extends "base.html" %}

{% block title %}Budget Setup - Budget Tracker{% endblock %}

{% block extra_css %}
<style>
    .category-item {
        background-color: var(--card-background-color);
        color: var(--text-color);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
    }

    .category-info {
        flex-grow: 1;
    }

    .category-budget,
    .category-actual,
    .category-remaining {
        width: 110px;
        text-align: right;
    }

    .add-category-form {
        background-color: var(--card-background-color);
        color: var(--text-color);
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        display: none;
    }

    .editable-budget {
        background-color: var(--card-background-color);
        color: var(--text-color);
        border: 1px solid #ced4da;
        padding: 2px 6px;
        border-radius: 4px;
        min-width: 80px;
        width: 100%;
        text-align: right;
    }

    .badge-success {
        background-color: #28a745;
    }

    .badge-danger {
        background-color: #dc3545;
    }

    .group-toggle.collapsed i {
        transform: rotate(-90deg);
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0"><i class="fas fa-calculator"></i> Budget Setup</h1>
    <div class="input-group" style="width: 250px;">
        <button class="btn btn-sm btn-modern-secondary" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
        <input type="month" class="form-control text-center" id="monthSelector" onchange="loadBudgetForMonth()">
        <button class="btn btn-sm btn-modern-secondary" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
    </div>
</div>

<div class="row">
    <div class="col-lg-8" id="budgetSections">

<!-- Income Categories -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-arrow-up text-success"></i> Income Sources
            <button class="btn btn-sm btn-light float-end ms-2" onclick="showAddCategoryForm('income')">
                <i class="fas fa-plus"></i> Add Income
            </button>
            <button class="btn btn-sm btn-light float-end" onclick="addGroup('income')">
                <i class="fas fa-folder-plus"></i> Add Group
            </button>
        </h5>
    </div>
    <div class="card-body">
        <div id="incomeCategories">
            <!-- Income categories will be loaded here -->
        </div>
        <div class="add-category-form" id="addIncomeForm">
            <h6>Add Income Category</h6>
            <form onsubmit="addCategory(event, 'income')">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Category Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Default Monthly Amount</label>
                        <input type="number" class="form-control" name="monthly_budget" step="0.01" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Add Category</button>
                <button type="button" class="btn btn-secondary" onclick="hideAddCategoryForm('income')">Cancel</button>
            </form>
        </div>
    </div>
</div>

<!-- Deduction Categories -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-minus-circle text-warning"></i> Deductions
            <button class="btn btn-sm btn-light float-end ms-2" onclick="showAddCategoryForm('deduction')">
                <i class="fas fa-plus"></i> Add Deduction
            </button>
            <button class="btn btn-sm btn-light float-end" onclick="addGroup('income')">
                <i class="fas fa-folder-plus"></i> Add Group
            </button>
        </h5>
    </div>
    <div class="card-body">
        <div id="deductionCategories">
            <!-- Deduction categories will be loaded here -->
        </div>
        <div class="add-category-form" id="addDeductionForm">
            <h6>Add Deduction Category</h6>
            <form onsubmit="addCategory(event, 'deduction')">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Deduction Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Default Monthly Amount</label>
                        <input type="number" class="form-control" name="monthly_budget" step="0.01" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Add Deduction</button>
                <button type="button" class="btn btn-secondary" onclick="hideAddCategoryForm('deduction')">Cancel</button>
            </form>
        </div>
    </div>
</div>

<!-- Expense Categories -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-arrow-down text-danger"></i> Expense Categories
            <button class="btn btn-sm btn-light float-end ms-2" onclick="showAddCategoryForm('expense')">
                <i class="fas fa-plus"></i> Add Expense
            </button>
            <button class="btn btn-sm btn-light float-end" onclick="addGroup('expense')">
                <i class="fas fa-folder-plus"></i> Add Group
            </button>
        </h5>
    </div>
    <div class="card-body">
        <div id="expenseCategories">
            <!-- Expense categories will be loaded here -->
        </div>
        <div class="add-category-form" id="addExpenseForm">
            <h6>Add Expense Category</h6>
            <form onsubmit="addCategory(event, 'expense')">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Category Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Default Monthly Budget</label>
                        <input type="number" class="form-control" name="monthly_budget" step="0.01" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Add Category</button>
                <button type="button" class="btn btn-secondary" onclick="hideAddCategoryForm('expense')">Cancel</button>
            </form>
        </div>
    </div>
</div>

<!-- Fund Expenses -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-piggy-bank text-primary"></i> Fund Contributions
        </h5>
    </div>
    <div class="card-body">
        <div id="fundCategories">
            <!-- Fund categories will be loaded here -->
        </div>
</div>
</div>
    </div> <!-- end col-lg-8 -->
    <div class="col-lg-4" id="summaryColumn">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Money To Budget</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="summaryTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="sum-tab" data-bs-toggle="tab" data-bs-target="#sum" type="button" role="tab">Summary</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="inc-tab" data-bs-toggle="tab" data-bs-target="#income-summary" type="button" role="tab">Income</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="exp-tab" data-bs-toggle="tab" data-bs-target="#expense-summary" type="button" role="tab">Expenses</button>
                    </li>
                </ul>
                <div class="tab-content border border-top-0 p-3" id="summaryTabContent">
                    <div class="tab-pane fade show active" id="sum" role="tabpanel">
                        <div id="summaryContent"></div>
                    </div>
                    <div class="tab-pane fade" id="income-summary" role="tabpanel">
                        <div id="incomeSummaryContent"></div>
                    </div>
                    <div class="tab-pane fade" id="expense-summary" role="tabpanel">
                        <div id="expenseSummaryContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- end col-lg-4 -->
</div> <!-- end row -->

{% endblock %}

{% block extra_js %}
<script>
    let currentMonth = new Date().toISOString().slice(0, 7);
    let allCategories = [];
    let comparisonData = {};

    let categoryGroups = [];
    $(document).ready(function() {
        $('#monthSelector').val(currentMonth);
        loadBudgetForMonth();
    });
    
    function changeMonth(direction) {
        const dateInput = document.getElementById('monthSelector');
        const currentValue = dateInput.value;
        const [year, month] = currentValue.split('-').map(Number);
        
        const newDate = new Date(year, month - 1 + direction, 1);
        const newYear = newDate.getFullYear();
        const newMonth = String(newDate.getMonth() + 1).padStart(2, '0');
        
        const newValue = `${newYear}-${newMonth}`;
        dateInput.value = newValue;
        currentMonth = newValue;
        
        loadBudgetForMonth();
    }
    
    function loadBudgetForMonth() {
        currentMonth = $('#monthSelector').val();
        const [year, month] = currentMonth.split('-');
        $('#comparisonMonth').text(`${getMonthName(parseInt(month))} ${year}`);
        
        loadBudgetComparison(function(){
            loadCategories();
        });
    }
    
    function getMonthName(month) {
        const months = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
        return months[month - 1];
    }
    
    function loadCategories() {
        $.get('/api/category-groups', function(groups) {
            categoryGroups = groups;
            $.get(`/api/budget/${currentMonth}`, function(data) {
                allCategories = data;

                const incomeCategories = data.filter(c => c.type === 'income' && !c.name.toLowerCase().includes('deduction'));
                const deductionCategories = data.filter(c => c.type === 'income' && c.name.toLowerCase().includes('deduction'));
                const expenseCategories = data.filter(c => c.type === 'expense');
                const fundCategories = data.filter(c => c.type === 'fund');

                const incomeGroups = getGroupNames('income').filter(n => !n.toLowerCase().includes('deduct'));
                const deductGroups = getGroupNames('income').filter(n => n.toLowerCase().includes('deduct'));
                displayCategories(incomeCategories, 'incomeCategories', incomeGroups);
                displayCategories(deductionCategories, 'deductionCategories', deductGroups);
                displayCategories(expenseCategories, 'expenseCategories', getGroupNames('expense'));
                displayCategories(fundCategories, 'fundCategories', getGroupNames('fund'));
            });
        });
    }

    function getGroupNames(type) {
        return categoryGroups.filter(g => g.type === type).map(g => g.name);
    }
    
    function loadBudgetComparison(callback) {
        $.get(`/api/budget-comparison/${currentMonth}`, function(data) {
            comparisonData = {};
            data.forEach(item => comparisonData[item.category] = item);
            if (callback) callback();
            updateSummary();
        });
    }
    
    function displayCategories(categories, containerId, groupNames = []) {
        const container = $('#' + containerId);

        if (categories.length === 0 && groupNames.length === 0) {
            container.html('<p class="text-muted">No categories added yet. Click "Add" to create your first category.</p>');
            return;
        }

        const groups = {};
        groupNames.forEach(g => groups[g] = []);
        categories.forEach(cat => {
            const group = cat.parent_category || 'Other';
            if (!groups[group]) groups[group] = [];
            groups[group].push(cat);
        });

        let html = "";
        Object.keys(groups).sort().forEach(g => {
            const safeId = g.replace(/\s+/g, "-");
            const total = groups[g].reduce((sum, c) => sum + (c.monthly_budget || 0), 0);
            html += `<div class="mb-3 category-group">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">${g} <span class="badge bg-secondary group-total d-none" id="total-${containerId}-${safeId}">${formatCurrency(total)}</span></h6>
                            <button class="btn btn-sm btn-outline-secondary group-toggle" data-bs-toggle="collapse" data-bs-target="#grp-${containerId}-${safeId}">
                                <i class="fas fa-caret-down"></i>
                            </button>
                        </div>
                        <div class="d-flex fw-bold text-end px-2 mt-2">
                            <div class="flex-grow-1"></div>
                            <div class="category-budget">Budget</div>
                            <div class="category-actual">Actual</div>
                            <div class="category-remaining">Remaining</div>
                            <div style="width:24px"></div>
                        </div>
                        <div id="grp-${containerId}-${safeId}" class="mt-2 collapse show group-categories" data-group="${g}">`;


            groups[g].sort((a,b)=>a.sort_order-b.sort_order).forEach(cat => {
                const comp = comparisonData[cat.name] || {actual:0};
                const remaining = cat.monthly_budget - comp.actual;
                html += `
                    <div class="category-item" data-id="${cat.id}">
                        <div class="category-info">
                            <h6 class="mb-1">${cat.name}</h6>
                        </div>
                        <div class="category-budget"><input type="number" step="0.01" class="editable-budget" data-id="${cat.id}" data-name="${cat.name.replace(/'/g, "\\'")}" data-amount="${cat.monthly_budget}" value="${cat.monthly_budget.toFixed(2)}"></div>
                        <div class="category-actual">${formatCurrency(comp.actual)}</div>
                        <div class="category-remaining">${formatCurrency(remaining)}</div>
                        <div class="dropdown ms-2">
                            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick='editCategory(${JSON.stringify(cat)})'>Edit Category</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteCategory(${cat.id})">Delete</a></li>
                            </ul>
                        </div>
                    </div>`;
            });

            html += '</div></div>';
        });

        container.html(html);

        Object.keys(groups).forEach(g => {
            const safeId = g.replace(/\s+/g, '-');
            const collapseId = `#grp-${containerId}-${safeId}`;
            $(collapseId).on('hide.bs.collapse', function(){
                $(`#total-${containerId}-${safeId}`).removeClass('d-none');
            });
            $(collapseId).on('show.bs.collapse', function(){
                $(`#total-${containerId}-${safeId}`).addClass('d-none');
            });
        });

        container.find('.group-categories').sortable({
            update: function(event, ui) {
                saveOrder(containerId);
            }
        });
    }

    function saveOrder(containerId) {
        const order = [];
        $('#' + containerId + ' .category-item').each(function(i, el) {
            order.push({id: $(el).data('id'), sort_order: i});
        });
        $.ajax({
            url: '/api/categories/reorder',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({order: order}),
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Unknown error';
                showToast('Error saving order: ' + error, 'error');
            }
        });
    }

    function editCategory(cat) {
        const newName = prompt('Category Name', cat.name);
        if (newName === null) return;
        const newBudget = prompt('Default Monthly Budget', cat.default_budget);
        if (newBudget === null || isNaN(newBudget)) return;
        const newGroup = prompt('Group', cat.parent_category || '');
        $.ajax({
            url: `/api/categories/${cat.id}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({name:newName, default_budget:parseFloat(newBudget), parent_category:newGroup}),
            success: function(){ showToast('Category updated'); loadBudgetForMonth(); },
            error: function(xhr){ const error = xhr.responseJSON?.error || 'Unknown error'; showToast('Error: '+error,'error'); }
        });
    }
    
    function updateAllDefaults() {
        if (confirm('This will save all current month budgets as the default for future months. Past months will not be affected. Continue?')) {
            // Gather all current month's budgets
            const updates = allCategories.map(cat => ({
                category_id: cat.id,
                amount: cat.monthly_budget
            }));
            
            // Send batch update
            $.ajax({
                url: '/api/categories/update-all-defaults',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ updates: updates }),
                success: function() {
                    showToast('Default budget saved successfully! This will apply to all future months.', 'success');
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Unknown error';
                    showToast('Error saving default budget: ' + error, 'error');
                }
            });
        }
    }
    
    function editBudgetForMonth(categoryId, categoryName, currentAmount) {
        const newAmount = prompt(`Edit budget for ${categoryName} for ${currentMonth}:`, currentAmount);
        if (newAmount === null || newAmount === '' || isNaN(newAmount)) return;
        
        $.ajax({
            url: `/api/budget/${currentMonth}/update`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                category_id: categoryId,
                amount: parseFloat(newAmount)
            }),
            success: function() {
                showToast('Budget updated for this month!');
                loadBudgetForMonth();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Unknown error';
                showToast('Error updating budget: ' + error, 'error');
            }
        });
    }
    
    function deleteCategory(id) {
        if (confirm('Are you sure you want to delete this category? This will delete the category and all associated transactions.')) {
            $.ajax({
                url: `/api/categories/${id}`,
                method: 'DELETE',
                success: function() {
                    showToast('Category deleted successfully!');
                    loadBudgetForMonth();
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Unknown error';
                    showToast('Error deleting category: ' + error, 'error');
                }
            });
        }
    }
    
    function showAddCategoryForm(type) {
        const formType = type === 'deduction' ? 'Deduction' : type.charAt(0).toUpperCase() + type.slice(1);
        $('#add' + formType + 'Form').slideDown();
    }
    
    function hideAddCategoryForm(type) {
        const formType = type === 'deduction' ? 'Deduction' : type.charAt(0).toUpperCase() + type.slice(1);
        const form = $('#add' + formType + 'Form');
        form.slideUp();
        form.find('form')[0].reset();
        // Ensure the form is hidden
        setTimeout(() => {
            form.hide();
        }, 500);
    }
    
    function addCategory(event, type) {
        event.preventDefault();
        
        const form = event.target;
        let categoryName = form.name.value;
        let categoryType = type;
        
        // For deductions, we store them as income type but with "Deduction" in the name
        if (type === 'deduction') {
            categoryType = 'income';
            if (!categoryName.toLowerCase().includes('deduction')) {
                categoryName = categoryName + ' Deduction';
            }
        }
        const monthlyBudget = parseFloat(form.monthly_budget.value);

        $.ajax({
            url: `/api/categories`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                name: categoryName,
                type: categoryType,
                monthly_budget: monthlyBudget,
                is_custom: true
            }),
            success: function () {
                showToast('Category added successfully!');
                loadBudgetForMonth();
                hideAddCategoryForm(type);
            },
            error: function (xhr) {
                const error = xhr.responseJSON?.error || 'Unknown error';
                showToast('Error adding category: ' + error, 'error');
            }
        });
    }

    function addGroup(type) {
        const name = prompt('Group Name');
        if (!name) return;
        $.ajax({
            url: '/api/category-groups',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ name: name, type: type }),
            success: function() {
                showToast('Group added successfully!');
                loadBudgetForMonth();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Unknown error';
                showToast('Error adding group: ' + error, 'error');
            }
        });
    }
    function updateSummary() {
        let incB=0, incA=0, dedB=0, dedA=0, expB=0, expA=0, fundB=0, fundA=0;
        Object.values(comparisonData).forEach(item => {
            if(item.type==='income') {
                if(item.category.toLowerCase().includes("deduction")) { dedB+=item.budgeted; dedA+=item.actual; }
                else { incB+=item.budgeted; incA+=item.actual; }
            } else if(item.type==='expense') { expB+=item.budgeted; expA+=item.actual; }
            else if(item.type==='fund') { fundB+=item.budgeted; fundA+=item.actual; }
        });
        const totalBudgetExp = expB + fundB + dedB;
        const totalActualExp = expA + fundA + dedA;
        const moneyToBudget = incA - totalActualExp;
        $('#summaryContent').html(`<p class="fs-4 text-center">${formatCurrency(moneyToBudget)}</p>`);
        const incPercent = incB ? incA / incB * 100 : 0;
        const expPercent = totalBudgetExp ? totalActualExp / totalBudgetExp * 100 : 0;
        const expClass = expPercent <= 100 ? "bg-success" : "bg-danger";
        $('#incomeSummaryContent').html(`
            <p>Earned ${formatCurrency(incA)} of ${formatCurrency(incB)}</p>
            <div class="progress"><div class="progress-bar bg-success" style="width:${Math.min(incPercent,100)}%">${incPercent.toFixed(0)}%</div></div>
            ${incPercent>100?'<div class="mt-2 text-success">Great job exceeding your goal!</div>':''}
        `);
        $('#expenseSummaryContent').html(`
            <p>Spent ${formatCurrency(totalActualExp)} of ${formatCurrency(totalBudgetExp)}</p>
            <div class="progress"><div class="progress-bar ${expClass}" style="width:${Math.min(expPercent,100)}%">${expPercent.toFixed(0)}%</div></div>
        `);
    }

    function saveBudget(input) {
        const current = parseFloat(input.data('amount')) || 0;
        const newVal = parseFloat(input.val());
        if (isNaN(newVal)) {
            input.val(current.toFixed(2));
            return;
        }
        if (newVal === current) return;
        $.ajax({
            url: `/api/budget/${currentMonth}/update`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ category_id: input.data('id'), amount: newVal }),
            success: function(){ showToast('Budget updated'); loadBudgetForMonth(); },
            error: function(xhr){ const error = xhr.responseJSON?.error || 'Unknown error'; showToast('Error updating budget: '+error,'error'); loadBudgetForMonth(); }
        });
    }

    $(document).on('keydown', '.editable-budget', function(e){
        if(e.key === 'Enter') { e.preventDefault(); $(this).blur(); }
    });

    $(document).on('blur', '.editable-budget', function(){
        saveBudget($(this));
    });
</script>
{% endblock %}