{% extends "base.html" %}

{% block title %}Transactions - Budget Tracker{% endblock %}

{% block extra_css %}
<style>
    /* Filter Bar */
    .filter-bar {
        background: white;
        padding: 1rem;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,.1);
        margin-bottom: 1.5rem;
    }
    
    .filter-group {
        margin-bottom: 0.75rem;
    }
    
    @media (min-width: 768px) {
        .filter-group {
            margin-bottom: 0;
        }
    }
    
    /* Transaction Table */
    .transaction-row {
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .transaction-row:hover {
        background-color: var(--gray-50);
        transform: translateX(2px);
    }
    
    /* Amount Colors */
    .amount-positive {
        color: var(--success-color);
        font-weight: 600;
    }
    
    .amount-negative {
        color: var(--danger-color);
        font-weight: 600;
    }
    
    /* Category Pills */
    .category-pill {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .category-income {
        background-color: rgba(34, 197, 94, 0.1);
        color: #16a34a;
    }
    
    .category-expense {
        background-color: rgba(239, 68, 68, 0.1);
        color: #dc2626;
    }
    
    .category-fund {
        background-color: rgba(102, 126, 234, 0.1);
        color: var(--primary-color);
    }
    
    /* Action Buttons */
    .action-buttons {
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .transaction-row:hover .action-buttons {
        opacity: 1;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--gray-600);
    }
    
    .empty-state i {
        font-size: 4rem;
        color: var(--gray-400);
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0">Transactions</h4>
    <button class="btn btn-modern-primary" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
        <i class="fas fa-plus me-1"></i> Add Transaction
    </button>
</div>

<!-- Filters -->
<div class="filter-bar">
    <div class="row g-3">
        <div class="col-md-3 filter-group">
            <label class="form-label small text-muted mb-1">Month</label>
            <div class="modern-input-group">
                <button class="btn btn-sm btn-modern-secondary" onclick="changeTransactionMonth(-1)">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <input type="month" class="form-control form-control-sm text-center" id="monthFilter" onchange="loadTransactions()">
                <button class="btn btn-sm btn-modern-secondary" onclick="changeTransactionMonth(1)">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        <div class="col-md-3 filter-group">
            <label class="form-label small text-muted mb-1">Type</label>
            <select class="form-select form-select-sm" id="typeFilter" onchange="loadTransactions()">
                <option value="">All Types</option>
                <option value="income">Income</option>
                <option value="expense">Expense</option>
                <option value="fund_withdrawal">Fund Withdrawal</option>
            </select>
        </div>
        <div class="col-md-3 filter-group">
            <label class="form-label small text-muted mb-1">Category</label>
            <select class="form-select form-select-sm" id="categoryFilter" onchange="loadTransactions()">
                <option value="">All Categories</option>
            </select>
        </div>
        <div class="col-md-3 filter-group">
            <label class="form-label small text-muted mb-1">Search</label>
            <div class="input-group input-group-sm">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="searchFilter" placeholder="Search..." oninput="loadTransactions()">
            </div>
        </div>
    </div>
</div>

<!-- Transactions Table -->
<div class="modern-card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table modern-table mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Merchant</th>
                        <th class="text-end">Amount</th>
                        <th width="100"></th>
                    </tr>
                </thead>
                <tbody id="transactionTableBody">
                    <!-- Transactions will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="fas fa-receipt"></i>
            <h5>No transactions found</h5>
            <p class="mb-0">Try adjusting your filters or add a new transaction.</p>
        </div>
    </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">Add Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTransactionForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small">Transaction Type</label>
                            <select class="form-select" name="transaction_type" required>
                                <option value="">Select Type</option>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                                <option value="fund_withdrawal">Fund Withdrawal</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Category</label>
                            <select class="form-select" name="category_id" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="amount" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Date</label>
                            <input type="date" class="form-control" name="date" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label small">Description</label>
                            <input type="text" class="form-control" name="description" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Merchant/Source</label>
                            <input type="text" class="form-control" name="merchant">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Notes</label>
                            <input type="text" class="form-control" name="notes">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-modern-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-modern-primary" onclick="saveTransaction()">Save Transaction</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Transaction Modal -->
<div class="modal fade" id="editTransactionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">Edit Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editTransactionForm">
                    <input type="hidden" name="id">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small">Transaction Type</label>
                            <select class="form-select" name="transaction_type" required>
                                <option value="">Select Type</option>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                                <option value="fund_withdrawal">Fund Withdrawal</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Category</label>
                            <select class="form-select" name="category_id" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="amount" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Date</label>
                            <input type="date" class="form-control" name="date" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label small">Description</label>
                            <input type="text" class="form-control" name="description" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Merchant/Source</label>
                            <input type="text" class="form-control" name="merchant">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Notes</label>
                            <input type="text" class="form-control" name="notes">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-modern-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-modern-primary" onclick="updateTransaction()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let categories = [];
    let currentMonth = new Date().toISOString().slice(0, 7);
    let editingTransactionId = null;
    
    $(document).ready(function() {
        $('#monthFilter').val(currentMonth);
        loadCategories();
        loadTransactions();
        $('input[name="date"]').val(new Date().toISOString().split('T')[0]);
        
        $('select[name="transaction_type"]').change(function() {
            updateCategoryDropdown($(this).val());
        });
        
        $('#editTransactionForm select[name="transaction_type"]').change(function() {
            updateCategoryDropdownEdit($(this).val());
        });
    });
    
    function changeTransactionMonth(direction) {
        const dateInput = document.getElementById('monthFilter');
        const currentValue = dateInput.value;
        const [year, month] = currentValue.split('-').map(Number);
        
        const newDate = new Date(year, month - 1 + direction, 1);
        const newYear = newDate.getFullYear();
        const newMonth = String(newDate.getMonth() + 1).padStart(2, '0');
        
        const newValue = `${newYear}-${newMonth}`;
        dateInput.value = newValue;
        currentMonth = newValue;
        
        loadTransactions();
    }
    
    function loadCategories() {
        $.get('/api/categories', function(data) {
            categories = data;
            
            const categoryFilter = $('#categoryFilter');
            categoryFilter.empty().append('<option value="">All Categories</option>');
            
            // Group by parent category
            const grouped = {};
            categories.forEach(cat => {
                const parent = cat.parent_category || 'Other';
                if (!grouped[parent]) grouped[parent] = [];
                grouped[parent].push(cat);
            });
            
            Object.keys(grouped).sort().forEach(parent => {
                const optgroup = $(`<optgroup label="${parent}">`);
                grouped[parent].forEach(cat => {
                    optgroup.append(`<option value="${cat.id}">${cat.name}</option>`);
                });
                categoryFilter.append(optgroup);
            });
        });
    }
    
    function updateCategoryDropdown(transactionType) {
        const select = $('select[name="category_id"]');
        select.empty().append('<option value="">Select Category</option>');
        
        if (transactionType === 'income') {
            const incomeCategories = categories.filter(c => c.type === 'income' && !c.name.toLowerCase().includes('deduction'));
            const deductionCategories = categories.filter(c => c.type === 'income' && c.name.toLowerCase().includes('deduction'));
            
            if (incomeCategories.length > 0) {
                select.append('<optgroup label="Income Sources">');
                incomeCategories.forEach(cat => {
                    select.append(`<option value="${cat.id}">${cat.name}</option>`);
                });
                select.append('</optgroup>');
            }
            
            if (deductionCategories.length > 0) {
                select.append('<optgroup label="Deductions">');
                deductionCategories.forEach(cat => {
                    select.append(`<option value="${cat.id}">${cat.name}</option>`);
                });
                select.append('</optgroup>');
            }
        } else if (transactionType === 'expense') {
            const grouped = {};
            categories.filter(c => c.type === 'expense').forEach(cat => {
                const parent = cat.parent_category || 'Other';
                if (!grouped[parent]) grouped[parent] = [];
                grouped[parent].push(cat);
            });
            
            Object.keys(grouped).sort().forEach(parent => {
                select.append(`<optgroup label="${parent}">`);
                grouped[parent].forEach(cat => {
                    select.append(`<option value="${cat.id}">${cat.name}</option>`);
                });
                select.append('</optgroup>');
            });
        } else if (transactionType === 'fund_withdrawal') {
            const fundCategories = categories.filter(c => c.parent_category === 'Savings');
            fundCategories.forEach(cat => {
                select.append(`<option value="${cat.id}">${cat.name}</option>`);
            });
        }
    }
    
    function updateCategoryDropdownEdit(transactionType) {
        const select = $('#editTransactionForm select[name="category_id"]');
        select.empty().append('<option value="">Select Category</option>');
        
        // Same logic as updateCategoryDropdown but for edit form
        updateCategoryDropdown.call(this, transactionType);
    }
    
    function loadTransactions() {
        const params = {
            month: $('#monthFilter').val(),
            type: $('#typeFilter').val(),
            category: $('#categoryFilter').val(),
            search: $('#searchFilter').val()
        };
        
        $.get('/api/transactions', params, function(transactions) {
            const tbody = $('#transactionTableBody');
            const emptyState = $('#emptyState');
            
            if (transactions.length === 0) {
                tbody.empty();
                emptyState.show();
                return;
            }
            
            emptyState.hide();
            let html = '';
            
            transactions.forEach(trans => {
                const typeClass = trans.type === 'income' ? 'category-income' : 
                                trans.type === 'expense' ? 'category-expense' : 'category-fund';
                const amountClass = trans.type === 'expense' || trans.type === 'fund_withdrawal' ? 'amount-negative' : 'amount-positive';
                const amountSign = trans.type === 'expense' || trans.type === 'fund_withdrawal' ? '-' : '+';
                
                html += `
                    <tr class="transaction-row">
                        <td>${new Date(trans.date).toLocaleDateString()}</td>
                        <td>
                            <div class="fw-medium">${trans.description}</div>
                            ${trans.notes ? `<small class="text-muted">${trans.notes}</small>` : ''}
                        </td>
                        <td><span class="category-pill ${typeClass}">${trans.category}</span></td>
                        <td>${trans.merchant || '-'}</td>
                        <td class="${amountClass} text-end">${amountSign}${formatCurrency(trans.amount)}</td>
                        <td>
                            <div class="action-buttons text-end">
                                <button class="btn btn-sm btn-link text-primary p-1" onclick="editTransaction(${trans.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-link text-danger p-1" onclick="deleteTransaction(${trans.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.html(html);
        });
    }
    
    function saveTransaction() {
        const button = $('#addTransactionModal .btn-modern-primary');
        const formData = $('#addTransactionForm').serializeArray();
        const data = {};
        formData.forEach(field => {
            data[field.name] = field.value;
        });
        
        setButtonLoading(button, true);
        
        $.ajax({
            url: '/api/transactions',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function() {
                $('#addTransactionModal').modal('hide');
                $('#addTransactionForm')[0].reset();
                showToast('Transaction added successfully!');
                loadTransactions();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Unknown error';
                showToast('Error: ' + error, 'error');
            },
            complete: function() {
                setButtonLoading(button, false);
            }
        });
    }
    
    function editTransaction(id) {
        editingTransactionId = id;
        
        $.get(`/api/transactions/${id}`, function(data) {
            $('#editTransactionForm input[name="id"]').val(data.id);
            $('#editTransactionForm select[name="transaction_type"]').val(data.transaction_type);
            
            updateCategoryDropdownEdit(data.transaction_type);
            
            setTimeout(() => {
                $('#editTransactionForm select[name="category_id"]').val(data.category_id);
            }, 100);
            
            $('#editTransactionForm input[name="amount"]').val(data.amount);
            $('#editTransactionForm input[name="description"]').val(data.description);
            $('#editTransactionForm input[name="merchant"]').val(data.merchant || '');
            $('#editTransactionForm input[name="date"]').val(data.date);
            $('#editTransactionForm input[name="notes"]').val(data.notes || '');
            
            $('#editTransactionModal').modal('show');
        }).fail(function() {
            showToast('Error loading transaction data', 'error');
        });
    }
    
    function updateTransaction() {
        const button = $('#editTransactionModal .btn-modern-primary');
        const formData = $('#editTransactionForm').serializeArray();
        const data = {};
        formData.forEach(field => {
            data[field.name] = field.value;
        });
        
        setButtonLoading(button, true);
        
        $.ajax({
            url: `/api/transactions/${editingTransactionId}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function() {
                $('#editTransactionModal').modal('hide');
                showToast('Transaction updated successfully!');
                loadTransactions();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Unknown error';
                showToast('Error: ' + error, 'error');
            },
            complete: function() {
                setButtonLoading(button, false);
            }
        });
    }
    
    function deleteTransaction(id) {
        if (confirm('Are you sure you want to delete this transaction?')) {
            $.ajax({
                url: `/api/transactions/${id}`,
                method: 'DELETE',
                success: function() {
                    showToast('Transaction deleted successfully!');
                    loadTransactions();
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Unknown error';
                    showToast('Error: ' + error, 'error');
                }
            });
        }
    }
</script>
{% endblock %}